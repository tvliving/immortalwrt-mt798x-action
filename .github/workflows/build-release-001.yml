name: ğŸ’» å›ºä»¶ç¼–è¯‘

on:
  workflow_dispatch:
    inputs:
      device:
        description: 'â¡ï¸ é€‰æ‹©éœ€æ„å»ºå›ºä»¶çš„è®¾å¤‡å‹å·'
        required: true
        default: 'netcore-n60-pro'
        type: choice
        options:
          - 'abt-asr3000'
          - 'cetron-ct3003'
          - 'cmcc-a10'
          - 'cmcc-rax3000m-emmc'
          - 'cmcc-rax3000m'
          - 'cmcc-rax3000me'
          - 'cmcc-xr30'
          - 'cmcc-xr30-emmc'          
          - 'umi-uax3000e'          
          - 'h3c-magic-nx30-pro'
          - 'imou-lc-hx3001'
          - 'nokia-ea0326gmp'
          - 'newland-nl-wr8103'
          - 'philips-hy3000'
          - 'qihoo-360t7'
          - 'sl-3000'
          - 'sl-3000-emmc'
          - 'xiaomi-mi-router-ax3000t'         
          - 'clx-s20p'
          - 'ikuai-q6000'
          - 'ikuai-q6000-emmc'
          - 'netcore-n60'
          - 'netcore-n60-pro'
          - 'netcore-n60-pro-512rom'
          - 'xiaomi-redmi-router-ax6000'
          - 'xiaomi-redmi-router-ax6000-512rom'
          - 'jdcloud-re-cp-03'
          - 'all-mt7981-devices'
          - 'all-mt7986-devices'
          - 'all-high-power-devices'
      lan_addr:
        description: 'ğŸŒ è®¾ç½®é»˜è®¤ LAN IP åœ°å€'
        required: true
        default: '10.0.0.1'
        type: string
      wifi_name:
        description: 'ğŸ›œ è®¾ç½®é»˜è®¤ WIFI åç§°ï¼ˆå¯é€‰ï¼Œé»˜è®¤ZeroWrtï¼‰'
        required: false
        default: 'ZeroWrt'
        type: string        
      root_password:
        description: 'ğŸ” è®¾ç½®é»˜è®¤ root å¯†ç ï¼ˆå¯é€‰ï¼Œé»˜è®¤passwordï¼‰'
        required: false
        default: 'password'
        type: string
      build_options:
        description: 'ğŸ”§ æ„å»ºé€‰é¡¹ï¼ˆå¯è¾“å…¥å¤šä¸ªï¼Œç”¨ç©ºæ ¼åˆ†éš”ï¼‰'
        required: false
        default: 'BUILD_FAST=y ENABLE_BPF=y'
        type: string

jobs:
  build-firmware:
    name: Build ${{ github.event.inputs.device }}
    runs-on: ubuntu-24.04
    permissions:
      contents: write  # èµ‹äºˆReleaseåˆ›å»ºæƒé™
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          path: immortalwrt-mt798x-action
          fetch-depth: 0

      - name: âš™ï¸ åˆå§‹åŒ–ç¯å¢ƒå˜é‡
        run: |
          sudo timedatectl set-timezone 'Asia/Shanghai'
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          echo "build_dir=/builder" >> $GITHUB_ENV
          echo "firmware_dir=/builder/openwrt/bin/targets" >> $GITHUB_ENV

      - name: ğŸ–¥ï¸ æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯
        run: |
          echo -e "\n\e[1;32mğŸ“Š CPU ä¿¡æ¯:\e[0m"
          grep 'model name' /proc/cpuinfo | head -1 | awk -F ': ' '{print $2}'
          echo -e "\n\e[1;32mğŸ§  å†…å­˜ä¿¡æ¯:\e[0m"
          free -h
          echo -e "\n\e[1;32mğŸ’¾ å­˜å‚¨ä¿¡æ¯:\e[0m"
          df -Th / /mnt

      - name: ğŸš€ å®‰è£…Caddyæ–‡ä»¶æœåŠ¡å™¨
        run: |
          # ä¸‹è½½å¹¶å®‰è£…Caddy
          sudo curl -L -o /usr/bin/caddy https://github.com/caddyserver/caddy/releases/download/v2.10.2/caddy_2.10.2_linux_amd64
          sudo chmod +x /usr/bin/caddy
          
          # é…ç½®Caddy
          cat > caddyfile << EOF
:8080 {
    root * $(pwd)/immortalwrt-mt798x-action
    file_server browse
}
EOF
          
          # å¯åŠ¨Caddy
          sudo caddy start --config caddyfile
          sleep 3
          if ! caddy status; then
            echo "âŒ Caddyå¯åŠ¨å¤±è´¥"
            exit 1
          fi

      - name: ğŸ§¹ é‡Šæ”¾ç£ç›˜ç©ºé—´
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          swap-storage: true

      - name: ğŸ› ï¸ é…ç½®OpenWrtç¼–è¯‘ç¯å¢ƒ
        uses: sbwml/openwrt-build-env@v1
        with:
          version: "ubuntu-24.04"

      - name: ğŸ“¦ å®‰è£…LLVM/Clang
        run: |
          sudo apt update
          sudo apt install -y llvm clang lld flex bison

      - name: ğŸ”¨ ç¼–è¯‘OpenWrtå›ºä»¶
        id: compile
        working-directory: /builder
        run: |
          # åˆ›å»ºç¼–è¯‘ç›®å½•
          mkdir -p openwrt && cd openwrt
          
          # å¯¼å‡ºæ„å»ºå‚æ•°
          export LAN="${{ github.event.inputs.lan_addr }}"
          export WIFI_NAME="${{ github.event.inputs.wifi_name }}"
          export ROOT_PASSWORD="${{ github.event.inputs.root_password }}"
          for opt in ${{ github.event.inputs.build_options }}; do export $opt; done
          
          # ä¸‹è½½å¹¶æ‰§è¡Œç¼–è¯‘è„šæœ¬
          curl -sS http://127.0.0.1:8080/build.sh -o build.sh
          chmod +x build.sh
          ./build.sh ${{ github.event.inputs.device }}
          
          # è·å–ç‰ˆæœ¬ä¿¡æ¯
          latest_release=$(git branch --show-current 2>/dev/null || echo "mt798x-$(date +%Y%m%d)")
          echo "latest_release=$latest_release" >> $GITHUB_ENV

      - name: ğŸ“ ç¼–è¯‘å¤±è´¥æ—¶è¾“å‡ºè¯¦ç»†æ—¥å¿—
        if: steps.compile.outcome == 'failure'
        working-directory: /builder/openwrt
        run: |
          make V=s 2>&1 | tee compile_error.log
          cp compile_error.log /builder/rom/ || true

      - name: ğŸ“¤ æ•´ç†å›ºä»¶æ–‡ä»¶
        working-directory: /builder
        run: |
          mkdir -p rom
          
          # æŸ¥æ‰¾æ‰€æœ‰å›ºä»¶æ–‡ä»¶ï¼ˆå…¼å®¹å¤šç§æ ¼å¼ï¼‰
          find ${{ env.firmware_dir }} -name "*sysupgrade*.bin" -type f -exec cp -v {} rom/ \;
          find ${{ env.firmware_dir }} -name "*.bin" -type f \
            -not -name "*bl2*" -not -name "*uboot*" -not -name "*dtb*" -not -name "*initramfs*" \
            -exec cp -vn {} rom/ \;
          
          # å®‰å…¨ç»Ÿè®¡å›ºä»¶æ•°é‡ï¼ˆæ ¸å¿ƒä¿®å¤ï¼šé¿å…exit code 2ï¼‰
          firmware_count=$(find rom -maxdepth 1 -name "*.bin" -type f | wc -l)
          
          # å…¼å®¹å…¶ä»–å›ºä»¶æ ¼å¼
          if [ $firmware_count -eq 0 ]; then
            echo "âš ï¸ æœªæ‰¾åˆ°binå›ºä»¶ï¼Œå°è¯•æŸ¥æ‰¾img/zipæ ¼å¼..."
            find ${{ env.firmware_dir }} -name "*.img" -o -name "*.zip" -type f -exec cp -vn {} rom/ \;
            firmware_count=$(find rom -maxdepth 1 -type f | wc -l)
          fi
          
          # éªŒè¯å›ºä»¶æ˜¯å¦å­˜åœ¨
          if [ $firmware_count -eq 0 ]; then
            echo "âŒ æœªæ‰¾åˆ°ä»»ä½•å›ºä»¶æ–‡ä»¶ï¼"
            find ${{ env.firmware_dir }} -type f
            exit 1
          fi
          
          echo "âœ… æˆåŠŸæ‰¾åˆ° $firmware_count ä¸ªå›ºä»¶æ–‡ä»¶ï¼š"
          ls -lh rom/

      - name: ğŸ“¤ ä¸Šä¼ å›ºä»¶åˆ°Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.inputs.device }}-${{ env.latest_release }}
          path: /builder/rom/*
          retention-days: 7

      - name: ğŸš€ åˆ›å»ºGitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.latest_release }}-${{ github.event.inputs.device }}
          name: ${{ env.latest_release }}-${{ github.event.inputs.device }}
          files: /builder/rom/*
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
